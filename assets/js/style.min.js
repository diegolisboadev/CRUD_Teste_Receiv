
// Scripts JS

// Mascara Dt Nascimento
new IMask(document.getElementById('dt_nascimento'), {
    mask: '00/00/0000'
});

// Mascara Dt Vencimento
new IMask(document.getElementById('dt_vencimento'), {
    mask: '00/00/0000'
});

// Mascara Valor (R$)
VMasker(document.getElementById("valor")).maskMoney();

// INICIO CPF e CNPJ - Mascara tanto CPF como CNPJ
// Colocar Formatação
document.getElementById('cpf_cnpj').addEventListener('focusout', (e) => {
    if (e.target.value.length <= 11) {
        e.target.value = e.target.value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g,"\$1.\$2.\$3\-\$4");
    } else {
        e.target.value = e.target.value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");
    }
});

// Retirar Formatação 
document.getElementById('cpf_cnpj').addEventListener('focusin', (e) => {
    e.target.value = e.target.value.replace(/(\.|\/|\-)/g,"");
});
// FIM CPF e CNPJ - Mascara tanto CPF como CNPJ

// REQUISIÇÕES VIA JS (FETCH API)

// Retorna Dados para a Listagem e Popula a Tabela de Listagem Devedores Via JS
fetchApi(`${basePath()}/listagem.php`, 'GET')
.then(data => { 
    const dataListagem = data;

    var conteudoTable = '';
    for(let [i, registro] of dataListagem.entries()) {
        conteudoTable += `<tr class="text-center">
                <td>${i + 1}</td>
                <td>${registro.nome}</td>
                <td>${registro.descricao}</td>
                <td>${dinheiroFormatoBrl(registro.valor)}</td>
                <td>${formateDate(registro.created_at, true)}</td>
                <td>${formateDate(registro.dt_vencimento)}</td>
                <td>
                    <button type="button" data-id=${registro.id} title="Info" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalInfo">
                        <i class="fa fa-info fa-1x"></i>
                    </button>
                    &emsp;
                    <button type="button" data-id=${registro.id} title="Editar" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalEditar">
                        <i class="fa fa-edit fa-1x"></i>
                    </button>
                    &emsp;
                    <button type="button" data-id=${registro.id} class="btn btn-outline-danger" title="Excluir"><i class="fa fa-trash fa-1x"></i></button>
                </td>
        </tr>`
    }

    document.getElementById('tbody').innerHTML = conteudoTable; 

});

// Retorna Dados para Modal Info Cliente/Devedor
document.getElementById('modalInfo').addEventListener('shown.bs.modal', function (e) {
    let dataId = e.relatedTarget.getAttribute('data-id');

    fetchApi(`${basePath()}/detalhes.php?idc=${dataId}`)
    .then(data => {
        console.info(data)
        var conteudoHtml = 
            `<div class="card w-100 shadow mx-auto rounded">
                <div class="card-body">
                <h4 class="card-title font-weigth-bold capitalized">Dados - ${data.nome}</h4>
                <hr>
                    <p class="card-text table-responsive">
                        <table class="table table-hover table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Nome</th>
                                    <th scope="col">CPF ou CNPJ</th>
                                    <th scope="col">Data de Nascimento</th>
                                    <th scope="col">Endereço</th>
                                    <th scope="col">Descrição</th>
                                    <th scope="col">Valor R$</th>
                                    <th scope="col">Vencimento</th>
                                    <th scope="col">Última Atualização</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="text-center">
                                    <th scope="row">${data.nome}</th>
                                    <td>${data.cpf_cnpj}</td>
                                    <td>${formateDate(data.dt_nascimento)}</td>
                                    <td>${data.endereco}</td>
                                    <td>${data.descricao}</td>
                                    <td>${dinheiroFormatoBrl(data.valor)}</td>
                                    <td>${formateDate(data.dt_vencimento)}</td>
                                    <td>${formateDate(data.updated_at)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </p>
                </div>
            </div>`;

        document.getElementById('modalInfo').getElementsByClassName('modal-body')[0]
        .innerHTML = conteudoHtml;

    });
})

// Dados de Edição para o Modal Cliente/Devedor
document.getElementById('modalEditar').addEventListener('show.bs.modal', function(e) {
    let dataId = e.relatedTarget.getAttribute('data-id');

    fetchApi(`${basePath()}/editar.php?idc=${dataId}`, 'POST')
    .then(data => {
        console.info('tes')
    });
});