
// Scripts JS

// Mascara Dt Nascimento
VMasker(document.getElementById("dt_nascimento")).maskPattern("99/99/9999");

// Mascara Dt Vencimento
VMasker(document.getElementById("dt_vencimento")).maskPattern("99/99/9999");

// Mascara Valor (R$)
VMasker(document.getElementById("valor")).maskMoney();

// INICIO CPF e CNPJ - Mascara tanto CPF como CNPJ
// Colocar Formatação
document.getElementById('cpf_cnpj').addEventListener('focusout', (e) => {
    if (e.target.value.length <= 11) {
        e.target.value = e.target.value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g,"\$1.\$2.\$3\-\$4");
    } else {
        e.target.value = e.target.value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");
    }
});

// Retirar Formatação 
document.getElementById('cpf_cnpj').addEventListener('focusin', (e) => {
    e.target.value = e.target.value.replace(/(\.|\/|\-)/g,"");
});
// FIM CPF e CNPJ - Mascara tanto CPF como CNPJ



// REQUISIÇÕES VIA JS (FETCH API)

// Retorna Dados para a Listagem e Popula a Tabela de Listagem Devedores Via JS
fetchApi(`${basePath()}/listagem.php`, 'GET')
.then(data => { 
    const dataListagem = data;

    var conteudoTable = '';
    for(let [i, registro] of dataListagem.entries()) {
        conteudoTable += `<tr class="text-center">
                <td class="font-bold">${i + 1}</td>
                <td>${registro.nome}</td>
                <td>${registro.descricao}</td>
                <td>${dinheiroFormatoBrl(registro.valor)}</td>
                <td>${formateDate(registro.dt_vencimento)}</td>
                <td>${formateDate(registro.created_at, true)}</td>
                <td>
                    <button type="button" data-id=${registro.id} title="Info" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalInfo">
                        <i class="fa fa-info fa-1x"></i>
                    </button>
                    &emsp;
                    <button type="button" data-id=${registro.id} title="Editar" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalEditar">
                        <i class="fa fa-edit fa-1x"></i>
                    </button>
                    &emsp;
                    <button type="button" data-id=${registro.id} title="Editar" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalExcluir">
                        <i class="fa fa-trash fa-1x"></i>
                    </button>
                </td>
        </tr>`
    }

    document.getElementById('tbody').innerHTML = conteudoTable; 

});

// Retorna Dados para Modal Info Cliente/Devedor
document.getElementById('modalInfo').addEventListener('shown.bs.modal', function (e) {
    let dataId = e.relatedTarget.getAttribute('data-id');

    fetchApi(`${basePath()}/detalhes.php?idc=${dataId}`)
    .then(data => {
        var conteudoHtml = 
            `<div class="card w-100 shadow mx-auto rounded">
                <div class="card-body">
                <h4 class="card-title font-weigth-bold capitalized">Dados - ${data.nome}</h4>
                <hr>
                    <p class="card-text table-responsive">
                        <table class="table table-hover table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">Nome</th>
                                    <th scope="col">CPF ou CNPJ</th>
                                    <th scope="col">Data de Nascimento</th>
                                    <th scope="col">Endereço</th>
                                    <th scope="col">Descrição</th>
                                    <th scope="col">Valor R$</th>
                                    <th scope="col">Vencimento</th>
                                    <th scope="col">Última Atualização</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="text-center">
                                    <th scope="row">${data.nome}</th>
                                    <td>${data.cpf_cnpj}</td>
                                    <td>${formateDate(data.dt_nascimento)}</td>
                                    <td>${data.endereco}</td>
                                    <td>${data.descricao}</td>
                                    <td>${dinheiroFormatoBrl(data.valor)}</td>
                                    <td>${formateDate(data.dt_vencimento)}</td>
                                    <td>${formateDate(data.updated_at, true)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </p>
                </div>
            </div>`;

        document.getElementById('modalInfo').getElementsByClassName('modal-body')[0]
        .innerHTML = conteudoHtml;

    });
})

// Dados de Edição para o Modal Cliente/Devedor
document.getElementById('modalEditar').addEventListener('show.bs.modal', function(e) {
    let dataId = e.relatedTarget.getAttribute('data-id');

    fetchApi(`${basePath()}/detalhes.php?idc=${dataId}`)
    .then(data => {
        var conteudoHtml = `
        <!-- Editar Devedores e Dividas -->
        <div class="card shadow rounded">
            <div class="card-body">
                    
                    <form action="/editar.php" method="POST" accept-charset="utf-8">
                        <input type="hidden" name="idc" value="${data.id}" required>
                        <div class="row mb-3">
                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="nome_edit">Devedor</label>
                                <input id="nomnome_edite" type="text" class="form-control" name="nome" value="${data.nome}" required>
                            </div>

                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="cpf_cnpj_edit">CPF/CNPJ</label>
                                <input id="cpf_cnpj_edit" type="text" class="form-control" name="cpf_cnpj" value="${data.cpf_cnpj}" required>
                            </div>

                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="dt_nascimento_edit">Data Nascimento</label>
                                <input id="dt_nascimento_edit" type="text" class="form-control" name="dt_nascimento" value="${formateDate(data.dt_nascimento)}" required>
                            </div>

                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="endereco_edit">Endereço</label>
                                <input id="endereco_edit" type="text" class="form-control" name="endereco" value="${data.endereco}">
                            </div>
                            
                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="descricao_edit">Descrição</label>
                                <input id="descricao_edit" type="text" class="form-control" name="descricao" value="${data.descricao}">
                            </div>

                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="valor_edit">Valor R$</label>
                                <input id="valor_edit" type="text" class="form-control" name="valor" value="${dinheiroFormatoBrl(data.valor)}">
                            </div>

                            <div class="col-md-4 col-sm-4 mt-3">
                                <label for="dt_vencimento_edit">Data Vencimento</label>
                                <input id="dt_vencimento_edit" type="text" class="form-control" name="dt_vencimento" value="${formateDate(data.dt_vencimento)}">
                            </div>

                        </div>

                        <div>
                            <button type="submit" class="btn btn-outline-info pull-right">Salvar</button>
                        </div>

                    </form>

            </div>
        </div>
        `;

        document.getElementById('modalEditar').getElementsByClassName('modal-body')[0]
        .innerHTML = conteudoHtml;

        validacaoCamposClienteDevedor();

    });

});

// Dados de Edição para o Modal Cliente/Devedor
document.getElementById('modalExcluir').addEventListener('show.bs.modal', function(e) {
    let dataId = e.relatedTarget.getAttribute('data-id');

    var conteudoHtml = `
        <div class="text-center text-danger">
            <form action="/excluir.php" method="POST" accept-charset="utf-8">
                <input type="hidden" name="idc" value="${dataId}"/>
                <h5 class="font-bold">Deseja Realmente Excluir esse Cliente/Devedor?</h5>

                <div>
                    <button type="submit" class="btn btn-outline-danger pull-right">Excluir</button>
                </div>

            </form>
        </div>
    `;

    document.getElementById('modalExcluir').getElementsByClassName('modal-body')[0]
    .innerHTML = conteudoHtml;

});


/**
 * Validar Campos Cliente/Devedor Modal Edição
 */
function validacaoCamposClienteDevedor() {

    // Mascara Dt Nascimento
    VMasker(document.getElementById("dt_nascimento_edit")).maskPattern("99/99/9999");

    // Mascara Dt Vencimento
    VMasker(document.getElementById("dt_vencimento_edit")).maskPattern("99/99/9999");

    // Mascara Valor (R$)
    VMasker(document.getElementById("valor_edit")).maskMoney();

    // INICIO CPF e CNPJ - Mascara tanto CPF como CNPJ
    // Colocar Formatação
    document.getElementById('cpf_cnpj_edit').addEventListener('focusout', (e) => {
        if (e.target.value.length <= 11) {
            e.target.value = e.target.value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/g,"\$1.\$2.\$3\-\$4");
        } else {
            e.target.value = e.target.value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");
        }
    });

    // Retirar Formatação 
    document.getElementById('cpf_cnpj_edit').addEventListener('focusin', (e) => {
        e.target.value = e.target.value.replace(/(\.|\/|\-)/g,"");
    });
    // FIM CPF e CNPJ - Mascara tanto CPF como CNPJ

}